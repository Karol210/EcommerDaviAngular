---
description: Estructura de servicios HTTP con tipado completo y manejo de errores
globs:
  - "**/*.service.ts"
  - "**/models/**/*.ts"
alwaysApply: true
---

# Servicios HTTP - Integración con API REST

## Regla General
Cuando se implemente un servicio HTTP que consume la API REST del backend, seguir estructura estándar con tipado completo y manejo de errores.

## 1. Estructura de Archivos

Para cada dominio de la API, crear:

```
src/app/core/
├── models/
│   ├── {entity}.model.ts           # Modelo interno
│   ├── {entity}-response.ts        # Response del backend
│   └── {entity}-request.ts         # Request (solo POST/PUT/PATCH)
└── services/
    └── {entity}.service.ts         # Servicio HTTP
```

## 2. Tipado de Response

**❌ INCORRECTO:**
```typescript
getProducts(): Observable<any> {
  return this.http.get('http://localhost:8080/api/products');
}
```

**✅ CORRECTO:**
```typescript
// product-response.ts
export interface ProductResponse {
  id: number;
  name: string;
  unitPrice: number;
  totalPrice: number;
  active: boolean;
}

// product.service.ts
listAll(): Observable<ApiResponse<ProductResponse[]>> {
  return this.http.get<ApiResponse<ProductResponse[]>>(
    `${this.baseUrl}/list-all`,
    { headers: this.getHeaders() }
  );
}
```

## 3. Respuesta Genérica del Backend

SIEMPRE usar `ApiResponse<T>` para encapsular respuestas:

```typescript
interface ApiResponse<T> {
  failure: boolean;
  code: number;
  message: string;
  body: T;
  timestamp: string;
}
```

## 4. URL Base del Servicio

**❌ INCORRECTO:**
```typescript
private url = 'http://localhost:8080/api/v1/products';
```

**✅ CORRECTO:**
```typescript
private readonly baseUrl = `${environment.apiUrl}/products`;
```

## 5. Headers y Autenticación

**❌ INCORRECTO:**
```typescript
const headers = new HttpHeaders({
  'Content-Type': 'application/json',
  'Authorization': `Bearer ${sessionStorage.getItem('token')}`,
  'User-Agent': 'Mozilla...',  // NO agregar headers del navegador
  'Accept-Language': 'es'
});
```

**✅ CORRECTO:**
```typescript
private getHeaders(): HttpHeaders {
  let headers = new HttpHeaders({ 'Content-Type': 'application/json' });
  const token = sessionStorage.getItem(StorageKeys.ADMIN_TOKEN);
  if (token) headers = headers.set('Authorization', `Bearer ${token}`);
  return headers;
}
```

## 6. Manejo de Errores

**❌ INCORRECTO:**
```typescript
getProducts() {
  return this.http.get(this.url); // Sin catchError
}
```

**✅ CORRECTO:**
```typescript
listAll(): Observable<ApiResponse<ProductResponse[]>> {
  return this.http.get<ApiResponse<ProductResponse[]>>(
    `${this.baseUrl}/list-all`,
    { headers: this.getHeaders() }
  ).pipe(
    catchError(error => {
      console.error('Error en listAll:', error);
      return throwError(() => error);
    })
  );
}
```

## 7. Agrupar Endpoints por Dominio

**❌ INCORRECTO:**
```typescript
// products-list.service.ts
// products-create.service.ts
// products-update.service.ts
```

**✅ CORRECTO:**
```typescript
// products.service.ts
class ProductsService {
  listAll()    // GET /products/list-all
  getById(id)  // GET /products/{id}
  create(req)  // POST /products/create
  update(id)   // PUT /products/{id}
  delete(id)   // DELETE /products/{id}
}
```

## Reglas Clave

- Response type creado (`-response.ts`)
- Request type creado si aplica (`-request.ts`)
- URL base usa `environment.apiUrl`
- Método `getHeaders()` implementado
- Token desde `StorageKeys` enum
- Todos los métodos HTTP tipados con `ApiResponse<T>`
- Todos los métodos tienen `catchError`
- Endpoints agrupados por dominio

---
**Versión:** Angular 19.x
